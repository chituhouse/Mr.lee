# 老李选题系统架构（v2.0 - 三平台版）

> 更新时间：2026-02-04
> 平台数：微博、抖音、今日头条（3个）

---

## 系统架构图

```
┌─────────────────────────────────────────────────────────────────────┐
│                        老李选题推荐系统                               │
│                       (jarvis-gateway)                               │
└─────────────────────────────────────────────────────────────────────┘

        ┌─────────────────────────────────────────────────┐
        │              数据源层                            │
        │  DailyHotApi (6688端口)                         │
        │    ├─ 微博热搜                                   │
        │    ├─ 抖音热搜                                   │
        │    └─ 今日头条热搜                               │
        └──────────────┬──────────────────────────────────┘
                       │ cron 每2小时
                       ↓
        ┌─────────────────────────────────────────────────┐
        │              采集层                              │
        │  scripts/fetch-hot-to-bitable.js                │
        │    - 拉取Top 50                                  │
        │    - 计算增长值、排名变化                        │
        │    - 批量写入Bitable                             │
        └──────────────┬──────────────────────────────────┘
                       │
                       ↓
┌──────────────────────────────────────────────────────────────────────┐
│                        数据中心层                                     │
│                   飞书多维表格 (Bitable)                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │
│  │  微博热搜表  │  │  抖音热搜表  │  │  头条热搜表  │              │
│  │  (15字段)    │  │  (17字段)    │  │  (16字段)    │              │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘              │
│         │                 │                 │                        │
│         └─────────────────┴─────────────────┘                        │
│                           │                                           │
│         ┌─────────────────┴─────────────────┐                        │
│         │                                    │                        │
│         ↓ AI字段实时生成                     ↓ Skill2定时生成         │
│  ┌─────────────────┐              ┌─────────────────┐               │
│  │  豆包版 (实时)  │              │  Claude版 (6AM) │               │
│  │  - 适配度（AI） │              │  - 适配度（Claude）│            │
│  │  - 文字梗（AI） │              │  - 文字梗（Claude）│            │
│  │  - 金句（AI）   │              │  - 金句（Claude）  │            │
│  └─────────────────┘              │  - 推荐理由       │               │
│                                   └─────────────────┘               │
│                                                                       │
│  ┌────────────────────────────────────────────────────┐             │
│  │            确认快照层（人工确认后保存）              │             │
│  │  - 确认版适配度                                     │             │
│  │  - 确认版金句                                       │             │
│  │  - 已确认 ✓                                        │             │
│  │  - 推荐到选题池 ✓                                   │             │
│  └────────────────────────────────────────────────────┘             │
└──────────────────────┬────────────────────────────────────────────────┘
                       │
                       ↓
        ┌─────────────────────────────────────────────────┐
        │              整理层                              │
        │  Skill3（改造中）- 对话窗口触发                  │
        │    @机器人 整理选题                              │
        │      - 读取"推荐到选题池"=true的记录            │
        │      - 转移到选题池表                            │
        └──────────────┬──────────────────────────────────┘
                       ↓
        ┌─────────────────────────────────────────────────┐
        │              选题池层                            │
        │  老李选题池表                                    │
        │    - 来源平台                                    │
        │    - 标题                                        │
        │    - 适配度、推荐理由、金句                      │
        │    - 完整脚本（Skill4生成）                      │
        └──────────────┬──────────────────────────────────┘
                       │
                       ↓
        ┌─────────────────────────────────────────────────┐
        │              生成层                              │
        │  Skill4 - 脚本生成器                             │
        │    - 三段式结构                                  │
        │    - 铺垫 → 误导 → 反转 → 点评                  │
        └─────────────────────────────────────────────────┘


┌──────────────────────────────────────────────────────────────────────┐
│                        System A - 飞书机器人                          │
│  src/index.js (WebSocket长连接)                                      │
│    - Claude Agent SDK                                                 │
│    - MCP Bitable Server                                               │
│    - 会话管理: data/sessions.json                                    │
└──────────────────────────────────────────────────────────────────────┘
```

---

## 数据流程图

```
┌─────────────────────────────────────────────────────────────────────┐
│  每2小时数据采集                                                      │
└─────────────────────────────────────────────────────────────────────┘

  DailyHotApi
      │
      ├─ GET /weibo?limit=50
      ├─ GET /douyin?limit=50
      └─ GET /toutiao?limit=50
      │
      ↓
  fetch-hot-to-bitable.js
      │
      ├─ 查询Bitable上一轮数据
      ├─ 读取本地今日首轮数据
      ├─ 计算: 增长值、排名变化、日增长值、状态
      │
      ↓
  批量写入Bitable（3张表）
      │
      ↓
  ┌─────────────────────────────────────────────────────────────┐
  │  实时触发AI字段生成（豆包1.8）                               │
  │    - 适配度（AI）: 判断高/中/低                             │
  │    - 文字梗（AI）: 挖掘文字游戏潜力                         │
  │    - 老李金句（AI）: 生成老李风格金句                       │
  └─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│  每天6:00 AM - Skill2生成（Claude Sonnet 4.5）                       │
└─────────────────────────────────────────────────────────────────────┘

  orchestrator.js
      │
      ├─ Step0: Skill5复盘学习（条件）
      ├─ Step1: 加载选题池标题（去重）
      │
      └─ Step2: 遍历3个平台
            │
            ├─ 获取最新批次未评分记录
            ├─ Skill2: 两阶段生成
            │     ├─ 快速筛选 → 适配度（高/中/低）
            │     └─ 深度生成 → 推荐理由 + 金句
            │
            ├─ Skill3: 质量审核（高适配度）
            │
            ├─ 写回Bitable（Claude版字段）
            │     ├─ 适配度（Claude）
            │     ├─ 文字梗（Claude）← 待实现
            │     ├─ 老李金句（Claude）
            │     └─ 推荐理由（Claude）
            │
            └─ 高适配度 → Skill4生成脚本 → 写入选题池

┌─────────────────────────────────────────────────────────────────────┐
│  人工浏览确认流程                                                     │
└─────────────────────────────────────────────────────────────────────┘

  团队浏览Bitable（Web端）
      │
      ├─ 对比豆包版 vs Claude版
      ├─ 选择更好的版本
      │
      ↓
  确认流程:
      ├─ 复制到"确认版金句"
      ├─ 勾选"已确认" ✓
      └─ 勾选"推荐到选题池" ✓
      │
      ↓
  @机器人触发Skill3
      │
      ├─ 读取"推荐到选题池"=true
      ├─ 转移到选题池表
      └─ 清除"推荐"标记

┌─────────────────────────────────────────────────────────────────────┐
│  AB测试对比（1-2周）                                                  │
└─────────────────────────────────────────────────────────────────────┘

  指标监控:
      ├─ 适配度准确率（人工标注100条）
      ├─ 金句质量（团队打分1-5分）
      ├─ 确认率（确认数/总生成数）
      ├─ 成本（豆包免费 vs Claude付费）
      └─ 时效性（豆包实时 vs Claude延迟）
      │
      ↓
  决策:
      ├─ 豆包≥80% → 废弃Claude
      ├─ 豆包60-80% → 双轨制（豆包初筛+Claude精选）
      └─ 豆包<60% → 保留Claude为主
```

---

## 关键改进点（v2.0）

### 1. 平台精简
- ❌ 删除：知乎、B站（相关度低）
- ✅ 保留：微博、抖音、今日头条（相关度高）
- 🎯 效果：数据量-40%，质量+30%

### 2. AB测试架构
- 豆包1.8（实时）vs Claude Sonnet 4.5（定时）
- 前台可视化对比
- 数据驱动决策

### 3. 字段统一（待执行）
- 3个表格字段需统一
- 补齐缺失字段（文字梗、Claude版、确认快照）

### 4. 人工把关流程
- AI辅助生成 → 人工确认 → 推荐到选题池
- 确认快照保护机制（防AI刷新覆盖）

---

## 成本估算

### 当前成本（5平台）
- 数据采集：免费（本地DailyHotApi）
- 豆包AI字段：免费
- Claude Skill2：约$5-10/月
- **总计：$5-10/月**

### 优化后成本（3平台）
- 数据采集：免费
- 豆包AI字段：免费
- Claude Skill2：约$3-6/月（减少40%）
- **总计：$3-6/月**

### 如果豆包够用
- 废弃Claude → **$0/月**

---

## 下一步执行清单

### 立即执行
- [x] 删除知乎、B站配置
- [ ] 统一3个表格字段
- [ ] 补齐Claude版字段
- [ ] 补齐豆包AI字段（文字梗）
- [ ] Git提交并部署

### AB测试期（1-2周）
- [ ] 配置豆包AI字段3个
- [ ] 运行Skill2生成Claude版
- [ ] 对比质量和成本
- [ ] 记录测试数据

### 决策期
- [ ] 选择最优方案
- [ ] 删除废弃字段/代码
- [ ] 改造Skill3为整理功能
- [ ] 优化整体流程

---

**版本：v2.0**
**日期：2026-02-04**
**状态：架构调整中**
