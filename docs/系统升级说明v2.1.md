# 系统升级说明 v2.1

> 基于《老李梭段子调性评估报告》的核心优化
> 升级日期：2026-02-04

---

## 升级概述

### 核心改进

1. **双重审核机制**（Skill3 重构）
   - 金句审核（Skill2后，轻量审核，2次重试）
   - 脚本审核（Skill4后，严格审核，3次重试）

2. **文字梗挖掘**（Skill4 增强）
   - 阶段1：识别文字梗潜力（成语改编/谐音梗/字面理解）
   - 阶段2：融入文字梗生成脚本

3. **AB测试机制**（选题池）
   - Skill生成版本（Claude Sonnet 4.5）
   - 豆包AI版本（Douyin Seed 1.8）
   - 持续对比优化

---

## 详细改动

### 1. Skill3 重构（双重审核机制）

**文件：** `agents/skills/skill3-reviewer.js`

**新增方法：**
- `reviewQuotes(topics, platformName)` - 审核金句
- `reviewScripts(topics, platformName)` - 审核脚本（终审）

**审核标准（基于评估报告）：**

#### 金句审核标准
✅ 语言口语化（大白话、反问句）
✅ 有文字游戏潜力（谐音梗、成语改编、字面理解）
✅ 符合打工人真实痛点
❌ 避免鸡汤式、文艺腔、段子手炫技

#### 脚本审核标准（更严格）
✅ 有三幕式结构（铺垫 → 误导 → 反转 → 点评）
✅ 语言口语化（"这事儿吧"、"你看啊"）
✅ 有文字游戏
✅ 有反转笑点
✅ 结尾自嘲不丧
❌ 避免鸡汤式、文艺腔、煽情式

**重试机制：**
- 金句审核：最多 2 次重试
- 脚本审核：最多 3 次重试
- 只针对有问题的选题重新生成

---

### 2. Skill4 增强（文字梗挖掘）

**文件：** `agents/skills/skill4-rewriter.js`

**新增流程：**
```
Step 1: identifyWordplay() - 识别文字梗潜力
  输入：标题
  输出：{ wordplay: "改编思路", type: "成语改编/谐音梗/..." }

Step 2: generateScript() - 生成完整脚本
  输入：标题 + 金句 + 文字梗
  输出：{ fullScript: "...", estimatedDuration: "30秒" }
```

**三幕式结构模板：**
1. 开场铺垫（日常场景）
2. 误导期待（让人以为要往某个方向）
3. 反转揭晓（真相出乎意料）
4. 老李点评（大白话总结，略带自嘲）

**写入选题池字段：**
- `文字梗` - Skill4 识别的文字梗思路
- `完整脚本` - Skill4 生成的脚本
- `预估时长` - 脚本时长估算

---

### 3. Orchestrator 更新（重试逻辑）

**文件：** `agents/orchestrator.js`

**新增逻辑：**

#### 金句审核重试（Skill2 之后）
```javascript
while (quoteAttempt <= 2) {
  quoteReview = await skill3.reviewQuotes(highMidTopics, name);

  if (quoteReview.approved) break;

  // 重新生成有问题的金句
  const topicsToRegenerate = 筛选有问题的选题;
  regenerated = await skill2.generateQuotes(topicsToRegenerate, name);
}
```

#### 脚本审核重试（Skill4 之后）
```javascript
while (scriptAttempt <= 3) {
  scriptReview = await skill3.reviewScripts(scriptsToReview, name);

  if (scriptReview.approved) break;

  // 重新生成有问题的脚本
  const recordsToRegenerate = 筛选有问题的记录;
  regeneratedRecords = await skill4.batchGenerate(recordsToRegenerate);
}
```

---

### 4. 选题池 AB 测试配置

**豆包AI字段（已手动配置）：**

#### 字段1：文字梗挖掘（AI）
- 触发条件：适配度 = 高 或 中
- 深度思考：Medium
- 配置文档：`docs/文字梗挖掘AI字段配置.md`

#### 字段2：脚本生成（AI）
- 触发条件：适配度 = 高
- 深度思考：High
- 配置文档：`docs/脚本生成AI字段配置.md`

**对比维度：**
| 字段 | Skill版本（Claude） | 豆包AI版本 |
|------|-------------------|-----------|
| 文字梗 | `文字梗`（Skill4挖掘） | `文字梗挖掘（AI）` |
| 完整脚本 | `完整脚本`（Skill4生成） | `脚本生成（AI）` |

---

## 数据流程图（更新后）

```
6:00 AM - 定时任务启动
  ↓
1. Prompt 热重载检查
  ↓
2. Skill5 复盘学习（条件执行）
  ↓
3. 遍历 3 个平台（微博、抖音、今日头条）
  ↓
4. Skill2 两阶段生成
  └─ 快速筛选（适配度：高/中/低）
  └─ 深度生成（高/中：生成金句）
  ↓
5. Skill3 金句审核（最多2次重试）✨ 新增
  └─ 审核标准：口语化、文字梗潜力、避免鸡汤式
  └─ 不通过 → 重新生成金句 → 再次审核
  ↓
6. 写回热搜表
  └─ 低适配：只写适配度
  └─ 高/中适配：写适配度 + 理由 + 金句
  ↓
7. 高适配选题 → Skill4 脚本生成 ✨ 增强
  └─ 阶段1：识别文字梗（成语/谐音/字面理解）
  └─ 阶段2：生成完整脚本（融入文字梗）
  ↓
8. Skill3 脚本审核（最多3次重试）✨ 新增
  └─ 审核标准：三幕式结构、反转、口语化、文字梗
  └─ 不通过 → 重新生成脚本 → 再次审核
  ↓
9. 写入选题池
  └─ 包含字段：文字梗、完整脚本、预估时长
  └─ 豆包AI自动生成：文字梗挖掘（AI）、脚本生成（AI）
  ↓
10. AB测试对比
  └─ 人工选择质量更好的版本
  └─ 未来：用数据优化 Skill Prompt
```

---

## 飞书 Prompt 配置更新

### 需要添加的 Prompt（在飞书配置表）

#### 1. Skill3 - 金句审核
**Prompt名称：** `Skill3 - 金句审核`

**内容：**
```
【角色】「老李动画」金句审核官

【老李人设】
30-40岁普通上班族，用最朴实的文字梗，说出打工人心里想说但不好意思说的大实话。

【审核标准】（超过 70% 合格则通过）
✅ 语言口语化（大白话、反问句、接地气比喻）
✅ 有文字游戏潜力（谐音梗、成语改编、字面理解）
✅ 符合打工人真实痛点（职场、生活、社交）
❌ 避免鸡汤式（"虽然苦但要微笑"）
❌ 避免文艺腔（"岁月如诗"）
❌ 避免段子手炫技（"连盐都买不起"）

【输出格式】
只返回 JSON：
{"approved":true/false,"feedback":"整体评价（50字以内）","issues":[{"title":"标题","problem":"问题（避免文艺腔/鸡汤式/不够口语化）"}]}
```

#### 2. Skill3 - 脚本审核
**Prompt名称：** `Skill3 - 脚本审核`

**内容：**
```
【角色】「老李动画」脚本终审官

【老李调性】
用最朴实的文字梗，说出打工人心里想说但不好意思说的大实话。

【审核标准】（必须 80% 以上合格）
✅ 有三幕式结构（铺垫 → 误导 → 反转 → 点评）
✅ 语言口语化（"这事儿吧"、"你看啊"、"说实话"）
✅ 有文字游戏（谐音/成语改编/字面理解）
✅ 有反转笑点（期待 vs 现实的落差）
✅ 结尾自嘲不丧（"我给你们个段子吧"）
❌ 避免鸡汤式收尾
❌ 避免文艺腔表达
❌ 避免段子手过度炫技
❌ 避免煽情式煽动

【输出格式】
只返回 JSON：
{"approved":true/false,"feedback":"整体评价（80字以内）","issues":[{"title":"标题","problem":"具体问题（缺乏反转/过于文艺/没有文字梗/不够口语化）"}]}
```

#### 3. Skill4 - 文字梗挖掘
**Prompt名称：** `Skill4 - 文字梗挖掘`

**内容：**
```
【角色】文字梗挖掘专家

【识别类型】
1. 成语改编（如"不负众望" → 真的不负/辜负众人期望）
2. 谐音梗（如"走漏风声" → 口袋漏风了）
3. 字面理解（如"胖的人" → 被打成平）

【正面案例】
- "铁杵磨成针" → 用铁杵打人（字面理解）
- "无法企及的帅" → 帅到无法企鹅/站立（谐音）
- "省钱的秘诀" → 钱都没了，还省啥钱（反转）

【输出格式】
只返回 JSON：
{"wordplay":"文字梗改编思路（20字以内）","type":"成语改编/谐音梗/字面理解/反转/无"}
```

#### 4. Skill4 - 完整脚本（更新）
**Prompt名称：** `Skill4 - 完整脚本`

**内容：**
```
【角色】你是「老李」本人，30-40岁打工人，用大白话吐槽生活

【语言风格】
✅ 口语化："这事儿吧"、"你看啊"、"说实话"
✅ 反问句："你知道为啥吗？"
✅ 自嘲收尾："我给你们个段子吧"
❌ 避免：鸡汤式、文艺腔、段子手炫技

【脚本结构】（3-4句话，30秒）
1. 开场铺垫（日常场景）
2. 误导期待（让人以为要往某个方向）
3. 反转揭晓（真相出乎意料）
4. 老李点评（大白话总结，略带自嘲）

【示例】
最近有人问我，怎么保持年轻？（开场）
我说，这个吧，有秘诀的……（铺垫）
别熬夜，多运动，保持好心态……（误导）
[老李：] 这样……你就没到变老的年龄！（反转）

【输出格式】
只返回 JSON：
{"fullScript":"完整脚本（3-4句话）","estimatedDuration":"预估时长（如30秒）"}
```

---

## 部署步骤

### 1. 更新飞书 Prompt 配置

在飞书多维表格的 Prompt 配置表中，添加/更新以上 4 个 Prompt。

### 2. 推送代码到服务器

```bash
# 本地（Mac）
git add -A
git commit -m "feat: 双重审核机制 + 文字梗挖掘

- Skill3 重构：金句审核(2次重试) + 脚本审核(3次重试)
- Skill4 增强：文字梗挖掘 + 三幕式脚本生成
- Orchestrator 更新：实现重试逻辑
- 基于《老李梭段子调性评估报告》优化审核标准

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"
git push origin main
```

### 3. 服务器部署

```bash
# SSH 连接服务器
ssh tencent

# 切换到项目目录
cd /home/jarvis/jarvis-gateway

# 拉取最新代码
git pull origin main

# 重启推荐引擎（测试运行）
# 先手动运行一次，验证逻辑
node agents/orchestrator.js

# 如果测试通过，等待明天 6:00 AM 自动运行
# Cron 任务会自动执行
```

### 4. 验证清单

- [ ] 飞书 Prompt 配置已更新（4个Prompt）
- [ ] 代码已推送到 GitHub
- [ ] 服务器已拉取最新代码
- [ ] 手动运行测试通过
- [ ] 观察日志，确认重试逻辑正常
- [ ] 检查选题池，确认文字梗和脚本已生成
- [ ] 对比 Skill 版本 vs 豆包AI版本质量

---

## 预期效果

### 质量提升
- **金句**：更口语化、更有文字梗、避免鸡汤式
- **脚本**：明确的三幕式结构、有反转笑点、融入文字梗

### 审核机制
- **轻量审核**（金句）：2次重试，快速过滤低质内容
- **严格审核**（脚本）：3次重试，确保最终产出质量

### AB测试
- **持续优化**：对比 Skill 版本 vs 豆包AI版本
- **数据驱动**：用实际效果优化 Prompt

---

## 监控指标

### 短期指标（1周内）
- [ ] 金句审核通过率 ≥ 70%
- [ ] 脚本审核通过率 ≥ 80%
- [ ] 重试次数平均值 < 1.5 次

### 中期指标（1个月内）
- [ ] 高适配选题占比 ≥ 15%
- [ ] 用户确认选题占比 ≥ 30%
- [ ] 文字梗命中率 ≥ 40%

### 长期目标（3个月内）
- [ ] 豆包AI vs Skill 质量对比完成
- [ ] 用优质 Prompt 替换现有 Skill Prompt
- [ ] 系统生成的脚本可直接用于制作

---

**升级完成时间：** 2026-02-04
**下次复盘时间：** 2026-02-11（一周后）
**负责人：** Claude Sonnet 4.5 + 老李团队
