# 当前会话总结（2026-02-04）

> 本文档记录当前会话的所有关键决策、技术细节、未完成任务，防止上下文压缩后遗忘。

---

## 一、核心决策

### 1. 架构方案：方案 C（Bitable AI 字段 + Skill2 混合）

**最终方案**：
- **Bitable AI 字段**（豆包模型）：实时生成适配度、文字梗、金句
- **Skill2 兜底**（Claude API）：如果豆包质量不行，在深度生成阶段补充
- **不需要 Skill6**：文字梗挖掘已集成到 Bitable AI 字段，避免过度设计

**理由**：
1. 豆包成本低、实时生效、团队可调 Prompt
2. 避免多一个独立模块增加维护成本
3. 如果未来需要批量对比、维护成语库，再独立成 Skill6

### 2. 自动化 vs 手动的边界

**用户明确要求**：
- ❌ **不允许本地直接执行操作**（本地是运维和发送指令，不是执行者）
- ✅ **必须自动化**（不接受手动配置方案）
- ✅ **服务器执行**（所有操作由服务器上的工具完成）

**技术约束**：
- 飞书 API **无法创建 AI 字段**（AI 字段只能在 Web 界面手动配置）
- MCP Bitable Server **没有 create_field 工具**（只能读写记录）
- 飞书机器人（Claude Agent SDK + MCP）可以操作表格，但无法添加字段

**结论**：
- 普通字段（确认快照）可以用脚本自动添加
- AI 字段必须手动配置（技术限制）
- 需要在群里 @机器人，让它引导用户完成配置

### 3. Git 配置问题

**服务器 Git 状态**：
- 当前 commit：ef8ccee（最新）✅
- Remote：git@github.com:chituhouse/Mr.lee.git（SSH）
- 之前遇到 ref lock 问题，但已通过 `git pull` 解决

**GitHub MCP 配置**：
- 用户询问是否需要给服务器配置 GitHub MCP
- **暂不需要**：服务器主要用于部署运维，不是开发节点
- 如果未来需要服务器 Claude Code 自主开发（改代码、提 PR），再配置

---

## 二、已完成的工作

### 1. 代码变更

#### 数据采集增强
- **文件**：`scripts/fetch-hot-to-bitable.js`
- **新增字段**：来源平台、摘要、移动端链接、采集批次 ID
- **用途**：采集批次用于增量查询和定期清理

#### Skill3 Prompt 外部化
- **文件**：`agents/skills/skill3-reviewer.js`
- **变更**：从硬编码改为 `promptLoader.getPrompt("Skill3", "质量审核")`
- **兜底**：飞书表格未配置时，使用结构化 Fallback Prompt

#### 模型升级
- **Skill2/3/4**：默认模型从 `claude-sonnet-4-20250514` 改为 `claude-sonnet-4-5-20250929`
- **配置**：`agents/config.js:6`

#### 硬编码路径修复
- **文件**：`src/claude.js:13-16`
- **变更**：MCP Server 路径改为环境变量 `MCP_NODE_PATH` / `MCP_BITABLE_PATH`

### 2. 文档创建

#### 核心文档（全部已推送到 GitHub）

1. **`docs/老李梭段子调性评估报告.md`** ✅
   - 75+ 手绘漫画样本分析
   - 文字梗是灵魂（40% 笑点来源）
   - 三幕式结构（铺垫 → 误导 → 反转 → 老李点评）
   - 语言风格清单（会说 vs 不会说）
   - 100 分制评分模型
   - **关键洞察**：当前系统缺乏文字梗识别能力

2. **`docs/bitable-ai-fields-guide.md`** ✅
   - 设计文档（理论层面）
   - AI 字段方案完整说明
   - 确认快照机制
   - 转移机制设计

3. **`docs/bitable-ai-fields-操作手册.md`** ✅
   - 详细操作指南
   - Prompt 模板（含 Few-shot 正反例）
   - 测试检查清单
   - 常见问题解答

4. **`docs/飞书AI字段配置清单.md`** ✅ **←最新**
   - 超简化清单
   - 7 个字段逐步配置
   - 完整 Prompt（直接复制）
   - 快速检查清单

5. **`CLAUDE.md`** ✅
   - 项目架构文档
   - 双系统架构说明
   - 服务器信息
   - 文件结构

#### 对话记录归档

- **结构**：`docs/conversations/local/` 和 `remote/`
- **Git LFS**：配置完成，管理 .jsonl 文件（93 MB）
- **README**：归档规范说明

### 3. 脚本工具

#### `scripts/add-ai-fields.js` ✅
- **功能**：自动添加 4 个普通字段（确认快照）
- **限制**：无法添加 AI 字段（飞书 API 限制）
- **用法**：`node scripts/add-ai-fields.js all`
- **状态**：已推送到 GitHub，服务器已同步

### 4. Git 清理

#### 排除文件
- `.gitignore` 已更新：排除 `老李梭段子手绘漫画/`（80+ 张图片）
- 调性报告已上传（不排除）

#### Python 方案归档
- `docs/archived-python-plan/` — 已废弃的 Python 版本规划

---

## 三、技术架构现状

### 系统架构（双系统）

```
System A（交互层）
飞书机器人 → Claude Agent SDK (opus-4-5) → MCP Bitable Server → 飞书表格
  - WebSocket 长连接
  - 会话持久化（data/sessions.json）
  - systemd 服务：jarvis-gateway.service

System B（自动化层）
crontab → orchestrator.js → Skill2/3/4 → Claude API (sonnet-4-5) → 飞书表格
  - 每天 6:00 AM 自动推荐
  - Prompt 外部化（飞书表格）
  - SHA256 热重载
```

### MCP Bitable Server 工具清单

```
✅ bitable_parse_url      - 解析表格 URL
✅ bitable_create_app     - 创建新表格
✅ bitable_list_tables    - 列出表格
✅ bitable_list_fields    - 列出字段
✅ bitable_list_records   - 读取记录
✅ bitable_create_record  - 创建记录
✅ bitable_update_record  - 更新记录
❌ bitable_create_field   - 【不存在】无法添加字段
```

### 飞书多维表格字段设计

#### 已有字段（数据采集）
- 标题、排名、热度、增长值、日增长值、排名变化、状态
- 来源平台、摘要、链接、移动端链接
- 抓取时间、采集批次

#### 需要新增的字段
**AI 字段（3 个）**：
1. 适配度（AI）— 单选（高/中/低）
2. 文字梗挖掘（AI）— 多行文本
3. 老李金句（AI）— 多行文本，触发条件：适配度=高

**普通字段（4 个）**：
1. 确认版适配度 — 单选
2. 确认版金句 — 多行文本
3. 已确认 — 复选框
4. 推荐到选题池 — 复选框

---

## 四、当前阻塞点

### 问题 1：AI 字段无法自动创建

**现状**：
- 飞书 API 不支持创建 AI 字段
- MCP Bitable Server 没有 create_field 工具
- 脚本只能创建普通字段

**可选方案**：

#### 方案 A：飞书机器人引导用户配置 ✅ **推荐**
```
用户在群里 @机器人："帮我配置 AI 字段"
         ↓
机器人回复：
1. 读取配置清单文档
2. 分步引导用户操作
3. 每步提供完整 Prompt
4. 用户在 Web 端配置
5. 配置完成后，机器人验证字段是否创建成功
```

**优势**：
- 符合用户要求（自动化 + 服务器执行）
- 机器人可以实时检查配置进度
- 用户只需复制粘贴 Prompt

#### 方案 B：完全手动配置
- 用户打开文档，按清单配置
- **缺点**：不符合用户的自动化要求 ❌

#### 方案 C：开发浏览器自动化脚本
- 用 Playwright 自动操作飞书 Web 端
- **缺点**：复杂度高，维护成本大，容易因 UI 变化失效 ❌

### 问题 2：服务器没有配置 GitHub MCP

**用户问题**：是否需要给服务器配置 GitHub MCP？

**我的建议**：
- **暂不需要**
- 服务器定位是"部署运维节点"，不是"开发节点"
- 当前工作流已够用：本地开发 → git push → 服务器 git pull → systemctl restart
- 如果未来需要服务器 Claude Code 自主开发（改代码、提 PR、自动修 bug），再配置

**如果要配置，需要**：
1. 在服务器上运行 `claude mcp add`
2. 配置 GitHub MCP Server
3. 配置 GitHub Token（需要 repo 权限）

---

## 五、下一步行动

### 立即执行（P0）

1. **用户在飞书群里 @机器人**
   ```
   @老李机器人 帮我配置热搜表的 AI 字段
   ```

2. **机器人执行**：
   - 读取 `docs/飞书AI字段配置清单.md`
   - 分步引导用户配置
   - 提供完整 Prompt
   - 验证配置是否成功

3. **用户测试**：
   - 填写测试数据
   - 查看 AI 生成结果
   - 反馈给机器人

### 后续优化（P1）

1. **根据测试结果调整 Prompt**
   - 如果适配度判断不准 → 调整判断标准
   - 如果文字梗挖掘无用 → 优化识别逻辑
   - 如果金句质量不行 → 补充更多正反例

2. **如果豆包能力不够**
   - 在 Skill2 深度生成阶段用 Claude API 补充
   - 修改 `agents/skills/skill2-generator.js`
   - 在 Prompt 里加文字梗挖掘逻辑

3. **建立案例库**
   - 从手绘漫画提取 10-15 个正面案例
   - 构造 10 个反面案例
   - 写入 Prompt 或飞书表格

### 待定（P2）

1. **转移机制实现**
   - webhook 触发 or 群聊触发
   - 从热搜表转移到选题池
   - 触发 Skill4 生成完整脚本

2. **Skill5 复盘优化**
   - 从确认的选题中学习偏好
   - 动态调整筛选标准

---

## 六、关键约束和原则

### 用户明确要求

1. **本地是运维节点，不执行操作** ❌
   - 不允许本地直接运行脚本
   - 不允许本地直接操作 Bitable
   - 本地只负责：开发、测试、发送指令

2. **必须自动化** ✅
   - 拒绝手动配置方案
   - 尽可能通过脚本/机器人完成

3. **服务器执行** ✅
   - 所有自动化操作在服务器上执行
   - 通过群聊 @机器人触发

### 技术限制

1. 飞书 API 无法创建 AI 字段
2. MCP Bitable Server 没有 create_field 工具
3. AI 字段只能在 Web 端手动配置

### 解决方案

**飞书机器人引导式配置**：
- 机器人读取配置文档
- 分步引导用户在 Web 端操作
- 提供完整 Prompt
- 验证配置成功

---

## 七、服务器状态

### Git 状态
- **当前 commit**：ef8ccee ✅
- **Remote**：git@github.com:chituhouse/Mr.lee.git（SSH）
- **工作区**：干净
- **与 GitHub 同步**：是 ✅

### 运行服务
- **DailyHotApi**：systemd 服务（端口 6688）
- **飞书机器人**：systemd 服务（jarvis-gateway.service）
- **Cron 任务**：
  - 每 2 小时：`fetch-hot-to-bitable.js`
  - 每天 6:00 AM：`orchestrator.js`

### 环境变量
- `.env` 已配置（FEISHU_APP_ID、ANTHROPIC_API_KEY 等）
- `RECOMMEND_MODEL=claude-sonnet-4-5-20250929` ✅

---

## 八、重要文件路径

### 服务器
- 项目路径：`/home/jarvis/jarvis-gateway`
- Node.js：`/home/linuxbrew/.linuxbrew/bin/node`
- 用户：jarvis
- SSH 别名：tencent

### 本地
- 项目路径：`/Users/yunchang/Documents/GitHub/Mr.lee`
- GitHub：`https://github.com/chituhouse/Mr.lee.git`

### 关键配置
- Prompt 配置表：appToken `HkTMbwNHqavfD6suRb0c8tNvn1f`
- MCP Server：`src/mcp-bitable.mjs`
- 环境变量模板：`.env.example`

---

## 九、待验证的假设

1. **豆包模型能力**
   - 假设：豆包能识别文字梗
   - 验证方法：测试"不负众望"、"走漏风声"等案例
   - 如果失败：用 Claude API 兜底

2. **Few-shot 效果**
   - 假设：3 个正例 + 3 个反例能显著提升质量
   - 验证方法：对比 Zero-shot vs Few-shot 生成结果
   - 如果不够：扩充到 10+ 案例

3. **适配度判断准确性**
   - 假设：豆包能准确判断高/中/低
   - 验证方法：测试 20 条热搜，对比人工判断
   - 如果偏差大：调整判断标准或用 Claude API

---

## 十、未来优化方向

### 短期（1 周内）
1. 测试豆包 AI 字段质量
2. 根据测试结果优化 Prompt
3. 建立 10 个正反例案例库

### 中期（1 个月内）
1. 实现转移机制（webhook / 群聊触发）
2. 优化 Skill5 复盘学习
3. A/B 测试新旧 Prompt 效果

### 长期（3 个月内）
1. 如果文字梗成为核心能力，独立成 Skill6
2. 建立成语改编库（50+ 个）
3. 建立反例库（100+ 条）
4. 量化指标追踪（高适配占比、审核通过率、确认率）

---

## 十一、知识沉淀

### 关键洞察

1. **文字梗是老李的灵魂** — 40% 笑点来源，当前系统缺失
2. **三幕式结构** — 铺垫 → 误导 → 反转 → 老李点评
3. **语言风格是边界** — 大白话 vs 鸡汤/文艺/段子手
4. **Skill6 不是必须的** — 避免过度设计，先验证 Bitable AI 字段能力

### 设计原则

1. **第一性原理** — 从需求本质出发，不盲目增加复杂度
2. **最小可行方案** — 先用 Bitable AI 字段验证，不行再上 Claude API
3. **人机协作边界** — AI 负责初筛，人负责最终决策
4. **知识外部化** — Prompt 存飞书表格，团队可调

---

## 十二、本次会话遗留问题

### 已解决 ✅
1. Sonnet 4.5 模型 ID 确认
2. Skill3 Prompt 外部化
3. 数据采集字段增强
4. 对话记录结构化（Git LFS）
5. 服务器 Git 初始化
6. .gitignore 配置
7. 调性报告分析
8. Bitable AI 字段方案设计

### 待解决 ⏳
1. **AI 字段配置** — 等用户在飞书 Web 端配置
2. **豆包能力验证** — 等配置完成后测试
3. **Prompt 优化** — 根据测试结果调整
4. **转移机制实现** — 等 AI 字段测试通过后开发

### 待确认 ❓
1. 是否需要给服务器配置 GitHub MCP？（我建议暂不需要）
2. 豆包质量如果不行，是否用 Claude API 兜底？（等测试结果）
3. 案例库是写进 Prompt 还是单独存表格？（看案例数量）

---

**总结**：当前会话已完成所有代码和文档准备工作，下一步是用户在飞书群里 @机器人触发 AI 字段配置流程，测试豆包能力，根据结果决定是否需要优化 Prompt 或用 Claude API 兜底。
